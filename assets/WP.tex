
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Work package environment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{workpackage}[1]%
{%

  \wptitle{#1}%
  \noindent
  
  %% WP objectives environment
  \newenvironment{wpobjectives}
  {
    \noindent
    \begin{framed}
      \vspace{-15pt}
      \subsubsection*{Objectives}
    }{%
    \end{framed}
    \noindent%
    \ignorespacesafterend
  }%

  %% WP description environment
  \newenvironment{wpdescription}
  {
    \noindent
    \begin{framed}
      \vspace{-15pt}
      \subsubsection*{Description of work}
    }{%
    \end{framed}
    \noindent%
    \ignorespacesafterend
  }%

  %% WP description environment
  \newenvironment{wpdeliverables}
  {
    \noindent
    \begin{framed}
      \vspace{-15pt}
      \subsubsection*{Deliverables}
    }{%
    \end{framed}
    \noindent%
    \ignorespacesafterend
  }%
}{%
  \par\noindent%
  \ignorespacesafterend
}%

\newcommand{\wptask}[6]
{% leader, contributors, start, end, title, description
  \refstepcounter{@wptask} 
  \stepcounter{@tottask}
  \stepcounter{@wp\arabic{@wpcount}tottk}  
  % Linear vector for task list  index entries
  \newcounter{@tk\arabic{@tottask}WP}
  \setcounter{@tk\arabic{@tottask}WP}{\value{@wpcount}}
  \newcounter{@tk\arabic{@tottask}T}
  \setcounter{@tk\arabic{@tottask}T}{\value{@wptask}}
  % Strings
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Task\arabic{@wptask}Leader\endcsname{\getPnum{#1}}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Task\arabic{@wptask}Contributors\endcsname{#2}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Task\arabic{@wptask}Start\endcsname{#3}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Task\arabic{@wptask}End\endcsname{#4}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Task\arabic{@wptask}Title\endcsname{#5}
%  \begin{shaded} \paragraph{Task \the@wptask} \textbf{#5 (M#3-M#4)}\end{shaded}
  \paragraph{Task \the@wptask:  #5 (M#3-M#4) } 
  \hfill \emph{Leader: \textbf{#1}. Contributors: #2}\\
  {#6}
  \vspace{-8pt}
  \if@draftmode%
  \newpage
  \fi
}%

\newcommand{\wpdeliverable}[5][12]
{ % [delivery date]{leader}{nature}{dissemination level}{title}
  % if no delivery date is specified, the default is M12
  \refstepcounter{@wpdeliv} 
  \stepcounter{@totdeliv}
  % Linear vector for sorting dates in delivery list table, and index entries
  \newcounter{@deliv\arabic{@totdeliv}date}
  \setcounter{@deliv\arabic{@totdeliv}date}{#1}
  \newcounter{@deliv\arabic{@totdeliv}WP}
  \setcounter{@deliv\arabic{@totdeliv}WP}{\value{@wpcount}}
  \newcounter{@deliv\arabic{@totdeliv}N}
  \setcounter{@deliv\arabic{@totdeliv}N}{\value{@wpdeliv}}
  \newcounter{@deliv\arabic{@totdeliv}D}
  \setcounter{@deliv\arabic{@totdeliv}D}{\value{@wpdeliv}}
  % Strings
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Deliv\arabic{@wpdeliv}DeliveryDate\endcsname{#1}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Deliv\arabic{@wpdeliv}Leader\endcsname{#2}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Deliv\arabic{@wpdeliv}Nature\endcsname{#3}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Deliv\arabic{@wpdeliv}DLevel\endcsname{#4}
  \expandafter\xdef\csname
  @wp\arabic{@wpcount}Deliv\arabic{@wpdeliv}Title\endcsname{#5}
  % Output
  \paragraph{\the@wpdeliv} {#5} \textbf{(M#1)}%\relax
  \vspace{-8pt}
}%

\newcommand{\personmonths}{\@ifnextchar{*}{\@leaderpersonmonths}{\@personmonths}}
\def\@leaderpersonmonths*#1#2{%
  \stepcounter{@wptotgroups}
  \addtocounter{@wp\arabic{@wpcount}totpm}{#2}
  \setcounter{@pmpnum}{\getPnum{#1}}
  \expandafter\xdef\csname @wpLeader\arabic{@wpcount}\endcsname{\getPnum{#1}}
  \addtocounter{@p\arabic{@pmpnum}totpm}{#2}
  \expandafter\xdef\csname
  @pmParticipant\arabic{@pmpnum}WP\arabic{@wpcount}\endcsname{#2} 
  \expandafter\xdef\csname
  @pmLeader\arabic{@pmpnum}WP\arabic{@wpcount}\endcsname{#2} 
}%

\newcommand{\@personmonths}[2]{%
  \stepcounter{@wptotgroups}
  \addtocounter{@wp\arabic{@wpcount}totpm}{#2}
  \setcounter{@pmpnum}{\getPnum{#1}}
  \addtocounter{@p\arabic{@pmpnum}totpm}{#2}
  \expandafter\xdef\csname
  @pmParticipant\arabic{@pmpnum}WP\arabic{@wpcount}\endcsname{#2} 
}%

%%% WP Table row
\newboolean{@stillundefined}

\newcommand{\wptablerow}[1]{%
  \setcounter{@wpcolempty}{0}
  \setcounter{@wpcolidx}{0}
  \whiledo{\value{@wpcolidx}<6}{%
    \stepcounter{@wpcolidx}
    \setboolean{@stillundefined}{true}
    \whiledo{\boolean{@stillundefined} \AND \value{@wpcolgroup}<\value{@pcount}}
    {% 
      \stepcounter{@wpcolgroup}
      \@ifundefined{@pmParticipant\arabic{@wpcolgroup}WP\arabic{@wpcount}}
      {\setboolean{@stillundefined}{true}}
      {\setboolean{@stillundefined}{false}
        \@ifundefined{@pmLeader\arabic{@wpcolgroup}WP\arabic{@wpcount}}
        {&#1}%
        {&\textbf{#1}}%
      }% 
    }% end whiledo stillundefined   
    \ifthenelse{\boolean{@stillundefined}}
    {\stepcounter{@wpcolempty}\null}
    {}%
  }% end whiledo colidx
  \ifthenelse{\value{@wpcolempty}>0}%
  {& \multicolumn{\arabic{@wpcolempty}}{X|}{}\\}%
  {\\}%
}%
